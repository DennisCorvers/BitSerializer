Input > Update manager (apply checks etc) > Network IO

s' = f(s, i)
s' = new state
s  = old state
i  = input
f  = simulation logic

each state is assigned a tick number
your simulation is a function, your state and input are the parameters for the function, and the function produces the new state

i[n] = localPoll + prediction; // prediction is for remote players
send(local_i[n]);
receive_input_confirmations; // either from server or others in P2P (let's assume we received tick k < n)
if (confirmed_i[k] != predicted_i[k])
  rollback_and_resimulate(s[k] to s[n]); // this should start over from k, re-simulating every tick until n to fix, and prepare for...
// now simulate next without the IF
  s[n+1] = f(s[n], i[n]);